<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å²¡å±±å®¶æ—æ—…éŠ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        earth: { 50:'#fbfaf9', 100:'#f5f3f0', 200:'#e8e4de', 300:'#d6cec4', 400:'#bgb0a0', 500:'#9c8e7a', 600:'#857662', 700:'#6d6050', 800:'#5a5044', 900:'#4a423a' },
                        sage: { 50:'#f4f7f4', 100:'#edf2ed', 500:'#84a98c', 600:'#6d8c74' },
                        terracotta: { 500: '#e07a5f', 600: '#d06a50' } // é»ç¶´è‰²
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f5f3f0; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .date-card.active { background-color: #5a5044; color: white; transform: scale(1.05); }
        .fab-btn { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        /* Checkbox Customization for Packing List */
        .pack-checkbox:checked + div { text-decoration: line-through; color: #bgb0a0; }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(245,243,240,0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }

        /* Stylized Route Map */
        .route-map { position: relative; width: 100%; height: 120px; background: #e8e4de; border-radius: 1rem; overflow: hidden; margin-top: 1rem; }
        .route-path { position: absolute; top: 50%; left: 10%; right: 10%; height: 4px; background: #9c8e7a; transform: translateY(-50%); border-radius: 2px; }
        .route-node { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 14px; height: 14px; background: white; border: 3px solid #5a5044; border-radius: 50%; z-index: 10; }
        .route-label { position: absolute; top: 65%; transform: translateX(-50%); font-size: 10px; font-weight: bold; color: #5a5044; white-space: nowrap; }
        .node-1 { left: 15%; } .node-2 { left: 40%; } .node-3 { left: 65%; } .node-4 { left: 85%; }
    </style>
</head>
<body class="text-earth-800 h-screen flex flex-col overflow-hidden max-w-md mx-auto bg-white shadow-2xl relative">

    <div id="loading-overlay">
        <i class="fa-solid fa-plane-departure text-4xl text-earth-600 animate-bounce mb-4"></i>
        <p class="text-earth-800 font-bold tracking-widest">OKAYAMA TRIP</p>
        <p class="text-xs text-earth-500 mt-2">è¼‰å…¥è¡Œç¨‹è³‡æ–™ä¸­...</p>
    </div>

    <!-- Header -->
    <header class="bg-earth-100 p-6 pb-2 rounded-b-3xl z-10 shadow-sm flex-shrink-0 relative">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h2 class="text-xs text-earth-600 tracking-widest uppercase mb-1 font-bold">Okayama & Kurashiki</h2>
                <h1 class="text-2xl font-black text-earth-900">å²¡å±±å®¶æ—æ—…éŠ <i class="fa-solid fa-cloud text-xs text-sage-500 ml-1"></i></h1>
            </div>
            <div class="bg-white px-3 py-2 rounded-xl shadow-sm flex items-center gap-2">
                <i class="fa-solid fa-sun text-orange-400 text-xl" id="header-weather-icon"></i>
                <div>
                    <div class="text-xs text-gray-400">å²¡å±±ç¸£</div>
                    <div class="font-bold text-earth-800" id="weather-temp">33Â°C</div>
                </div>
            </div>
        </div>

        <!-- Date Slider (Only visible on Itinerary and Accounting views) -->
        <div class="flex overflow-x-auto gap-3 pb-4 hide-scrollbar snap-x transition-all duration-300" id="date-slider-container">
            <div class="flex gap-3" id="date-slider"></div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto p-5 pb-24 relative bg-white" id="main-container">
        
        <!-- ================= VIEW: ITINERARY ================= -->
        <div id="view-itinerary" class="block animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-earth-800 border-b-2 border-sage-500 pb-1">ç•¶æ—¥è¡Œç¨‹</h3>
                <span class="text-xs bg-earth-200 px-3 py-1 rounded-full text-earth-800 font-bold shadow-sm" id="current-date-display-itin">8/20 (å››)</span>
            </div>
            
            <div class="relative border-l-2 border-earth-200 ml-3 space-y-6" id="itinerary-list">
                <!-- JS populated -->
            </div>
            
            <div id="empty-itinerary" class="hidden text-center py-10 text-earth-400">
                <i class="fa-regular fa-calendar-plus text-4xl mb-3"></i>
                <p>ç„¡è¡Œç¨‹ï¼Œé»æ“Šå³ä¸‹è§’æ–°å¢</p>
            </div>
        </div>

        <!-- ================= VIEW: WEATHER & OVERVIEW ================= -->
        <div id="view-weather" class="hidden animate-fade-in space-y-6">
            <h3 class="font-bold text-lg text-earth-800 border-b-2 border-sage-500 pb-1 mb-4">å¤©æ°£èˆ‡è·¯ç·šç¸½è¦½</h3>
            
            <!-- Route Map Mockup -->
            <div class="bg-earth-50 p-4 rounded-2xl shadow-sm border border-earth-100">
                <h4 class="text-sm font-bold text-earth-700 mb-2"><i class="fa-solid fa-map-location-dot mr-1"></i> è¡Œç¨‹ç§»å‹•è·¯ç·š</h4>
                <div class="route-map">
                    <div class="route-path"></div>
                    <div class="route-node node-1"></div><div class="route-label node-1">å²¡å±±æ©Ÿå ´</div>
                    <div class="route-node node-2"></div><div class="route-label node-2">å²¡å±±å¸‚å€</div>
                    <div class="route-node node-3"></div><div class="route-label node-3">å€‰æ•·(é€£å®¿)</div>
                    <div class="route-node node-4"></div><div class="route-label node-4">é·²ç¾½å±±</div>
                </div>
            </div>

            <!-- Daily Weather Cards -->
            <div class="space-y-3" id="weather-cards-container">
                <!-- JS Populated -->
            </div>
        </div>

        <!-- ================= VIEW: ACCOUNTING ================= -->
        <div id="view-accounting" class="hidden animate-fade-in">
            <div class="bg-earth-500 text-white p-5 rounded-2xl shadow-lg mb-6 relative bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <div class="text-earth-100 text-sm mb-1 font-medium">ç¸½è¡Œç¨‹æ”¯å‡º (TWD)</div>
                        <div class="text-3xl font-black tracking-tight" id="total-expense-twd">NT$ 0</div>
                        <div class="text-xs text-earth-200 mt-1 bg-black/20 inline-block px-2 py-0.5 rounded backdrop-blur-sm">åŒ¯ç‡: <span id="display-rate">0.22</span></div>
                    </div>
                    <button onclick="openSettlementModal()" class="bg-white text-earth-800 text-xs font-bold px-3 py-2 rounded-lg shadow-md hover:bg-earth-50 transition-colors flex items-center gap-1">
                        <i class="fa-solid fa-calculator"></i> çµç®—
                    </button>
                </div>
                <div class="mt-4 flex -space-x-2 overflow-hidden relative z-10" id="member-avatars"></div>
            </div>

            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <h3 class="font-bold text-lg text-earth-800 border-b-2 border-sage-500 pb-1">æ¶ˆè²»ç´€éŒ„</h3>
                    <span class="text-xs bg-earth-200 px-3 py-1 rounded-full text-earth-800 font-bold shadow-sm" id="current-date-display-acc">8/20 (å››)</span>
                </div>
                <button onclick="openMemberModal()" class="text-xs text-earth-500 font-bold border border-earth-300 px-2 py-1 rounded hover:bg-earth-100 bg-white shadow-sm"><i class="fa-solid fa-users-gear mr-1"></i>æˆå“¡</button>
            </div>

            <div class="space-y-3" id="expense-list"></div>
            <div id="empty-expenses" class="hidden text-center py-8 text-earth-400 text-sm">
                <i class="fa-solid fa-receipt text-2xl mb-2 opacity-50"></i><p>æœ¬æ—¥å°šç„¡æ¶ˆè²»ç´€éŒ„</p>
            </div>
        </div>

        <!-- ================= VIEW: TOOLS ================= -->
        <div id="view-tools" class="hidden animate-fade-in space-y-6">
            <h3 class="font-bold text-lg text-earth-800 border-b-2 border-sage-500 pb-1 mb-4">è¡Œå‰æº–å‚™èˆ‡å·¥å…·ç›’</h3>

            <!-- Data Hub -->
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-sage-50 p-4 rounded-2xl border border-sage-100 shadow-sm flex flex-col items-center justify-center text-center cursor-pointer hover:bg-sage-100 transition" onclick="alert('æ¨¡æ“¬é–‹å•Ÿèˆªç­è³‡è¨Šï¼š\nå»ç¨‹ IT214 11:30-15:05\nå›ç¨‹ IT215 17:55-19:55')">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-sage-600 mb-2 shadow-sm"><i class="fa-solid fa-plane-ticket text-lg"></i></div>
                    <span class="text-sm font-bold text-earth-800">èˆªç­è³‡è¨Š</span>
                </div>
                <div class="bg-earth-50 p-4 rounded-2xl border border-earth-200 shadow-sm flex flex-col items-center justify-center text-center cursor-pointer hover:bg-earth-100 transition" onclick="alert('ä½å®¿è³‡è¨Šï¼š\nåˆ©å¤«é¦¬å…‹æ–¯å²¡å±±å€‰æ•·ç«™å‰é£¯åº—\n(Hotel Livemax Okayama Kurashiki Station)\nåœ°å€ï¼šå€‰æ•·å¸‚é˜¿çŸ¥2-1-20\nå…¥ä½ï¼š8/20-8/23 (3æ™š)')">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-earth-600 mb-2 shadow-sm"><i class="fa-solid fa-hotel text-lg"></i></div>
                    <span class="text-sm font-bold text-earth-800">é£¯åº—æ†‘è­‰</span>
                </div>
                <div class="bg-earth-50 p-4 rounded-2xl border border-earth-200 shadow-sm flex flex-col items-center justify-center text-center cursor-pointer hover:bg-earth-100 transition" onclick="alert('ç§Ÿè»Šè³‡è¨Šï¼š\nå²¡å±±æ©Ÿå ´å–é‚„\næ•¸é‡ï¼š2å°è»Š (å…±11äºº)\néœ€æº–å‚™ï¼šå°ç£é§•ç…§æ­£æœ¬ã€æ—¥æ–‡è­¯æœ¬ã€è­·ç…§')">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-earth-600 mb-2 shadow-sm"><i class="fa-solid fa-car-side text-lg"></i></div>
                    <span class="text-sm font-bold text-earth-800">ç§Ÿè»Šè³‡è¨Š</span>
                </div>
                <div class="bg-earth-50 p-4 rounded-2xl border border-earth-200 shadow-sm flex flex-col items-center justify-center text-center cursor-pointer hover:bg-earth-100 transition" onclick="openRulesModal()">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-earth-600 mb-2 shadow-sm"><i class="fa-solid fa-triangle-exclamation text-lg"></i></div>
                    <span class="text-sm font-bold text-earth-800">æ—…éŠè¦ç¯„</span>
                </div>
            </div>

            <!-- Emergency Info -->
            <div class="bg-red-50 p-4 rounded-2xl border border-red-100 shadow-sm">
                <h4 class="text-sm font-bold text-red-800 mb-3"><i class="fa-solid fa-phone-volume mr-1"></i> ç·Šæ€¥è¯çµ¡è³‡è¨Š</h4>
                <div class="space-y-2">
                    <a href="tel:110" class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm text-earth-800 hover:bg-gray-50">
                        <span class="font-bold text-sm"><i class="fa-solid fa-building-shield text-blue-600 w-5"></i> è­¦å¯Ÿå±€</span>
                        <span class="font-black tracking-widest">110</span>
                    </a>
                    <a href="tel:119" class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm text-earth-800 hover:bg-gray-50">
                        <span class="font-bold text-sm"><i class="fa-solid fa-truck-medical text-red-600 w-5"></i> æ¶ˆé˜²/æ•‘è­·</span>
                        <span class="font-black tracking-widest">119</span>
                    </a>
                    <div class="bg-white p-3 rounded-xl shadow-sm text-earth-800">
                        <div class="font-bold text-sm mb-1"><i class="fa-solid fa-passport text-earth-600 w-5"></i> é§å¤§é˜ªè¾¦äº‹è™• (å²¡å±±è½„å€)</div>
                        <div class="text-xs text-earth-500">æ€¥é›£æ•‘åŠ©ï¼š+81-90-8794-4568</div>
                    </div>
                </div>
            </div>

            <!-- Packing List -->
            <div class="bg-white border border-earth-200 rounded-2xl shadow-sm overflow-hidden">
                <div class="bg-earth-100 p-3 flex justify-between items-center">
                    <h4 class="font-bold text-earth-800 text-sm"><i class="fa-solid fa-suitcase-rolling mr-1"></i> è¡Œææ‰“åŒ…æ¸…å–®</h4>
                    <button onclick="openPackingModal()" class="text-xs bg-earth-800 text-white px-2 py-1 rounded shadow"><i class="fa-solid fa-plus"></i> æ–°å¢</button>
                </div>
                <div class="p-4 space-y-4" id="packing-lists-container">
                    <!-- JS Populated grouped by category -->
                </div>
            </div>

        </div>

    </main>

    <!-- Floating Action Button (Only for Itinerary & Accounting) -->
    <button id="main-fab" onclick="handleFabClick()" class="fab-btn absolute bottom-24 right-5 bg-terracotta-600 text-white w-14 h-14 rounded-full flex items-center justify-center text-xl shadow-lg hover:bg-terracotta-700 transition-transform z-20">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 w-full max-w-md bg-white border-t border-earth-200 p-2 pb-6 z-30 flex justify-around rounded-t-2xl shadow-[0_-10px_15px_rgba(0,0,0,0.03)]">
        <button onclick="switchView('itinerary')" class="nav-item w-full py-2 flex flex-col items-center gap-1 text-terracotta-600 transition-colors" id="nav-itinerary">
            <i class="fa-solid fa-map-location-dot text-xl"></i><span class="text-[10px] font-bold">è¡Œç¨‹</span>
        </button>
        <button onclick="switchView('weather')" class="nav-item w-full py-2 flex flex-col items-center gap-1 text-earth-400 transition-colors" id="nav-weather">
            <i class="fa-solid fa-cloud-sun text-xl"></i><span class="text-[10px] font-bold">å¤©æ°£</span>
        </button>
        <button onclick="switchView('accounting')" class="nav-item w-full py-2 flex flex-col items-center gap-1 text-earth-400 transition-colors" id="nav-accounting">
            <i class="fa-solid fa-wallet text-xl"></i><span class="text-[10px] font-bold">åˆ†å¸³</span>
        </button>
        <button onclick="switchView('tools')" class="nav-item w-full py-2 flex flex-col items-center gap-1 text-earth-400 transition-colors" id="nav-tools">
            <i class="fa-solid fa-toolbox text-xl"></i><span class="text-[10px] font-bold">å·¥å…·</span>
        </button>
    </nav>

    <!-- ================= MODALS ================= -->

    <!-- Itinerary Edit Modal -->
    <div id="modal-itinerary" class="fixed inset-0 bg-black/60 hidden z-50 flex items-end sm:items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md max-h-[90vh] overflow-y-auto rounded-t-3xl sm:rounded-3xl p-6 transform translate-y-full transition-transform duration-300 relative hide-scrollbar" id="modal-itinerary-content">
            <button onclick="closeModal('modal-itinerary')" class="absolute top-4 right-4 text-earth-400 hover:text-earth-800 bg-earth-100 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-xl font-black text-earth-900 mb-5">ç·¨è¼¯è¡Œç¨‹</h3>
            
            <form id="form-itinerary" class="space-y-4">
                <input type="hidden" id="edit-id">
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-earth-500 mb-1">æ™‚é–“</label>
                        <input type="time" id="input-time" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none focus:border-sage-500" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-earth-500 mb-1">åˆ†é¡</label>
                        <select id="input-category" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none text-sm focus:border-sage-500">
                            <option value="attraction">ğŸ“¸ æ™¯é»</option>
                            <option value="food">ğŸ½ï¸ ç¾é£Ÿ</option>
                            <option value="transport">ğŸš— äº¤é€š</option>
                            <option value="shopping">ğŸ›ï¸ è³¼ç‰©</option>
                            <option value="hotel">ğŸ¨ ä½å®¿</option>
                            <option value="activity">ğŸŸï¸ æ´»å‹•</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">è¡Œç¨‹åç¨±</label>
                    <input type="text" id="input-title" placeholder="ä¾‹ï¼šå²¡å±±åŸ" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none font-bold text-earth-900 focus:border-sage-500" required>
                </div>

                <!-- Advanced Info Box -->
                <div class="bg-earth-50 p-4 rounded-xl border border-earth-200 space-y-3">
                    <h4 class="text-xs font-bold text-earth-700 mb-2 border-b border-earth-200 pb-1">è©³ç´°è³‡è¨Š (é¸å¡«)</h4>
                    
                    <div>
                        <label class="block text-[10px] font-bold text-earth-500 mb-1"><i class="fa-solid fa-location-dot"></i> åœ°é» / å°èˆªé—œéµå­—</label>
                        <input type="text" id="input-location" placeholder="è¼¸å…¥ Google Map é—œéµå­—" class="w-full bg-white p-2 text-sm rounded border border-earth-200 outline-none">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-[10px] font-bold text-earth-500 mb-1"><i class="fa-regular fa-clock"></i> å»ºè­°åœç•™</label>
                            <input type="text" id="input-duration" placeholder="ä¾‹: 1.5å°æ™‚" class="w-full bg-white p-2 text-sm rounded border border-earth-200 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-earth-500 mb-1"><i class="fa-solid fa-car"></i> äº¤é€šæ™‚é–“</label>
                            <input type="text" id="input-transport" placeholder="ä¾‹: è»Šç¨‹30åˆ†" class="w-full bg-white p-2 text-sm rounded border border-earth-200 outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-terracotta-600 mb-1"><i class="fa-solid fa-lightbulb"></i> å¿…åƒ/å¿…è²·/Tips</label>
                        <input type="text" id="input-tips" placeholder="ä¾‹: å¿…åƒæ°´èœœæ¡ƒè–ä»£" class="w-full bg-white p-2 text-sm rounded border border-terracotta-500 outline-none">
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-blue-600 mb-1"><i class="fa-solid fa-square-parking"></i> åœè»Š/åŠ æ²¹è³‡è¨Š</label>
                        <input type="text" id="input-parking" placeholder="ä¾‹: é™„è¿‘æœ‰ Times åœè»Šå ´" class="w-full bg-white p-2 text-sm rounded border border-blue-200 outline-none">
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-earth-500 mb-1">å‚™è¨»èªªæ˜</label>
                        <textarea id="input-notes" placeholder="å…¶ä»–å‚™è¨»äº‹é …..." class="w-full bg-white p-2 text-sm rounded border border-earth-200 outline-none h-16 resize-none"></textarea>
                    </div>
                </div>

                <div class="pt-2">
                    <button type="submit" class="w-full bg-terracotta-600 text-white py-3 rounded-xl font-black shadow-md hover:bg-terracotta-700">å„²å­˜è¡Œç¨‹</button>
                    <button type="button" id="btn-delete-itinerary" class="hidden w-full bg-red-50 text-red-600 border border-red-200 py-3 rounded-xl font-bold mt-3">åˆªé™¤æ­¤è¡Œç¨‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="modal-expense" class="fixed inset-0 bg-black/60 hidden z-50 flex items-end sm:items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 transform translate-y-full transition-transform duration-300 relative" id="modal-expense-content">
            <button onclick="closeModal('modal-expense')" class="absolute top-4 right-4 text-earth-400 hover:text-earth-800 bg-earth-100 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-xl font-black text-earth-900 mb-5">æ–°å¢æ”¯å‡º</h3>
            <form id="form-expense" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">é …ç›®</label>
                    <input type="text" id="exp-title" placeholder="ä¾‹ï¼šåˆé¤ - ç‡’è‚‰" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none focus:border-sage-500" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">ä»£å¢Šä»˜æ¬¾äºº</label>
                    <select id="exp-payer" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none text-sm"></select>
                </div>
                <div class="flex gap-3">
                    <div class="w-1/3">
                        <label class="block text-xs font-bold text-earth-500 mb-1">å¹£åˆ¥</label>
                        <select id="exp-currency" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none text-sm font-bold text-earth-800">
                            <option value="JPY">JPY Â¥</option>
                            <option value="TWD">TWD NT$</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-earth-500 mb-1">é‡‘é¡</label>
                        <input type="number" id="exp-amount" placeholder="0" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">ç™¼ç”Ÿæ—¥æœŸ</label>
                    <select id="exp-date" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none text-sm"></select>
                </div>
                <div class="bg-earth-50 p-3 rounded-xl border border-earth-200">
                    <div class="flex justify-between items-end mb-2">
                        <label class="block text-xs font-bold text-earth-500">é¸æ“‡åˆ†å¸³æˆå“¡</label>
                        <button type="button" onclick="toggleAllMembers()" id="btn-toggle-members" class="text-[10px] text-sage-600 font-bold border border-sage-600 px-2 py-0.5 rounded bg-white">å–æ¶ˆå…¨é¸</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2" id="split-members-container"></div>
                </div>
                <button type="submit" class="w-full bg-sage-600 text-white py-3 rounded-xl font-black shadow-md hover:bg-sage-700 mt-2">æ–°å¢ç´€éŒ„</button>
            </form>
        </div>
    </div>

    <!-- Packing Add Modal -->
    <div id="modal-packing" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-5/6 max-w-sm rounded-3xl p-6 transform scale-95 transition-transform duration-300 relative" id="modal-packing-content">
            <button onclick="closeModal('modal-packing')" class="absolute top-4 right-4 text-earth-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h3 class="text-lg font-black text-earth-900 mb-4">æ–°å¢ç‰©å“</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">ç‰©å“åˆ†é¡</label>
                    <select id="pack-category" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 text-sm outline-none">
                        <option value="carryOn">ğŸ’ éš¨èº«èƒŒåŒ…</option>
                        <option value="cabin">ğŸ§³ æ‰‹æè¡Œæ (æ©Ÿè‰™)</option>
                        <option value="checked">ğŸ“¦ æ‰˜é‹è¡Œæ</option>
                        <option value="shopping">ğŸ›’ è³¼ç‰©æ¸…å–® (æ—¥æœ¬è²·)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">ç‰©å“åç¨±</label>
                    <input type="text" id="pack-name" placeholder="ä¾‹ï¼šè­·ç…§ / è…¸èƒƒè—¥" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">æ•¸é‡</label>
                    <input type="number" id="pack-qty" value="1" min="1" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none">
                </div>
                <button onclick="addPackingItem()" class="w-full bg-earth-800 text-white py-3 rounded-xl font-bold shadow-md">åŠ å…¥æ¸…å–®</button>
            </div>
        </div>
    </div>

    <!-- Rules Modal -->
    <div id="modal-rules" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-5/6 max-w-md max-h-[80vh] overflow-y-auto rounded-3xl p-6 transform scale-95 transition-transform duration-300 relative hide-scrollbar" id="modal-rules-content">
            <button onclick="closeModal('modal-rules')" class="absolute top-4 right-4 text-earth-400 bg-earth-100 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-xl font-black text-earth-900 mb-4 border-b-2 border-terracotta-500 pb-2 inline-block">æ—¥æœ¬æ—…éŠè¦ç¯„æé†’</h3>
            <div class="space-y-4 text-sm text-earth-800 mt-4 leading-relaxed">
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                    <strong class="text-blue-800"><i class="fa-solid fa-car-rear"></i> è‡ªé§•é ˆçŸ¥ï¼š</strong>
                    <ul class="list-disc pl-5 mt-1 space-y-1 text-blue-900/80">
                        <li>æ—¥æœ¬ç‚ºå³é§•ï¼Œé å·¦è¡Œé§›ã€‚</li>
                        <li><strong>çµ•å°ç¦æ­¢é…’é§•</strong>ï¼Œé€£å‰¯é§•éƒ½æœƒå—ç½°ã€‚</li>
                        <li>è¦‹åˆ°ã€Œæ­¢ã¾ã‚Œã€(å€’ä¸‰è§’å½¢ç´…åº•ç™½å­—)ï¼Œå¿…é ˆ<strong>å®Œå…¨åœæ­¢</strong>3ç§’å†é–‹ã€‚</li>
                        <li>è»Šä¸Šå°èˆªé€šå¸¸å¯è¼¸å…¥å•†å®¶é›»è©±è™Ÿç¢¼è¨­å®šç›®çš„åœ°ã€‚</li>
                    </ul>
                </div>
                <div class="bg-earth-50 p-3 rounded-xl border border-earth-200">
                    <strong class="text-earth-800"><i class="fa-solid fa-train-subway"></i> ä¹˜è»Šèˆ‡å…¬å…±ç¦®å„€ï¼š</strong>
                    <ul class="list-disc pl-5 mt-1 space-y-1 text-earth-600">
                        <li>é›»è»Šã€å…¬è»Šå…§è«‹å°‡æ‰‹æ©Ÿè½‰éœéŸ³ï¼Œä¸”<strong>ç¦æ­¢è¬›é›»è©±</strong>ã€‚</li>
                        <li>æ‰‹æ‰¶æ¢¯é€šå¸¸é å·¦ç«™ç«‹ï¼ˆé—œè¥¿åœ°å€å¦‚å¤§é˜ªé å³ï¼Œä½†å²¡å±±ä»¥é å·¦ç‚ºä¸»ï¼‰ã€‚</li>
                        <li>è¡—ä¸Šè«‹å‹¿é‚Šèµ°é‚Šåƒï¼ˆç¥­å…¸æ”¤ä½å‘¨é‚Šé™¤å¤–ï¼‰ï¼Œä¹Ÿå‹¿äº‚ä¸Ÿåƒåœ¾ï¼Œåƒåœ¾æ¡¶é€šå¸¸åœ¨è¶…å•†æˆ–è²©è³£æ©Ÿæ—ã€‚</li>
                    </ul>
                </div>
                <div class="bg-sage-50 p-3 rounded-xl border border-sage-200">
                    <strong class="text-sage-800"><i class="fa-solid fa-shop"></i> è³¼ç‰©èˆ‡å…ç¨…ï¼š</strong>
                    <ul class="list-disc pl-5 mt-1 space-y-1 text-sage-900/80">
                        <li>å…ç¨…(Tax Free)é–€æª»é€šå¸¸ç‚ºå–®åº—æ»¿ 5,000 æ—¥åœ“(æœªç¨…)ã€‚</li>
                        <li>çµå¸³æ™‚è«‹ä¸»å‹•å‡ºç¤ºè­·ç…§æ­£æœ¬ï¼ˆç…§ç‰‡ç„¡æ•ˆï¼‰ã€‚</li>
                        <li>å…ç¨…åŒ…è£ï¼ˆæ¶ˆè€—å“ï¼‰åœ¨æ—¥æœ¬å¢ƒå…§ä¸å¯æ‹†å°ã€‚</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Settlement Modal -->
    <div id="modal-settlement" class="fixed inset-0 bg-black/60 hidden z-50 flex items-end sm:items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md h-[80vh] sm:h-auto sm:max-h-[85vh] sm:rounded-3xl rounded-t-3xl p-6 transform translate-y-full transition-transform duration-300 flex flex-col" id="modal-settlement-content">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h3 class="text-xl font-black text-earth-900">çµç®—æ¸…å–®</h3>
                <button onclick="closeModal('modal-settlement')" class="bg-earth-100 rounded-full w-8 h-8"><i class="fa-solid fa-xmark text-earth-500"></i></button>
            </div>
            <div class="bg-earth-50 p-4 rounded-xl mb-4 flex-shrink-0 border border-earth-200">
                <label class="block text-xs font-bold text-earth-600 mb-2">å…¨åŸŸåŒ¯ç‡è¨­å®š (JPY â†’ TWD)</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="settle-rate" step="0.001" class="flex-1 p-3 rounded-xl border border-earth-300 text-lg font-bold outline-none text-center">
                    <button onclick="saveRateAndCalc()" class="bg-sage-600 text-white px-4 py-3 rounded-xl font-bold shadow hover:bg-sage-700">å„²å­˜è¨ˆç®—</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto pr-1 hide-scrollbar space-y-3" id="settlement-results"></div>
        </div>
    </div>

    <!-- Members Modal -->
    <div id="modal-members" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-3/4 max-w-sm rounded-3xl p-6 transform scale-95 transition-transform duration-300" id="modal-members-content">
            <h3 class="text-lg font-black text-earth-900 mb-4 border-b-2 border-sage-500 pb-1 inline-block">æˆå“¡ç®¡ç†</h3>
            <div id="members-list" class="space-y-2 mb-4 max-h-[40vh] overflow-y-auto hide-scrollbar"></div>
            <div class="flex gap-2">
                <input type="text" id="new-member-name" placeholder="è¼¸å…¥åå­—" class="flex-1 bg-earth-50 p-3 rounded-xl border border-earth-200 text-sm outline-none">
                <button onclick="addMember()" class="bg-earth-800 text-white px-4 rounded-xl font-bold"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div class="mt-6 text-center">
                <button onclick="closeModal('modal-members')" class="w-full bg-earth-200 text-earth-800 font-bold py-3 rounded-xl">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // âš ï¸ é‡è¦ï¼šè«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Firebase è¨­å®š
        // ==========================================
        const firebaseConfig = {
            apiKey: "", 
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };
        // ==========================================

        let db;
        let unsubscribe;

        // --- Data & State ---
        // å²¡å±±è¡Œç¨‹æ—¥æœŸ
        const tripDates = [
            { date: '2026-08-20', label: '8/20', day: 'å››' },
            { date: '2026-08-21', label: '8/21', day: 'äº”' },
            { date: '2026-08-22', label: '8/22', day: 'å…­' },
            { date: '2026-08-23', label: '8/23', day: 'æ—¥' },
        ];

        const weatherMockData = {
            '2026-08-20': { temp: '33Â°C', feels: '36Â°C', icon: 'fa-sun', color: 'text-orange-500', cloth: 'çŸ­è¢–çŸ­è¤² + é®é™½å¸½', desc: 'æ™´æœ—ç‚ç†±ï¼Œæ³¨æ„é˜²æ›¬' },
            '2026-08-21': { temp: '34Â°C', feels: '37Â°C', icon: 'fa-sun', color: 'text-red-500', cloth: 'æ¶¼æ„Ÿè¡£ + å¢¨é¡é™½å‚˜', desc: 'é…·ç†±ï¼Œå¤šè£œå……æ°´åˆ†' },
            '2026-08-22': { temp: '32Â°C', feels: '35Â°C', icon: 'fa-cloud-sun', color: 'text-orange-400', cloth: 'é€æ°£æ£‰éº» + é˜²æ›¬å¤–å¥—', desc: 'æ™´æ™‚å¤šé›²ï¼Œæµ·é‚Šé¢¨å¤§' },
            '2026-08-23': { temp: '31Â°C', feels: '34Â°C', icon: 'fa-cloud', color: 'text-gray-400', cloth: 'è¼•è–„é•·è¢– + èˆ’é©ä¾¿é‹', desc: 'å¤šé›²èˆ’é©ï¼Œé©åˆå¸‚å€æ•£æ­¥' }
        };

        const defaultItinerary = [
            // Day 1
            { id: 101, date: '2
